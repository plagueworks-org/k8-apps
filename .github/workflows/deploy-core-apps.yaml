name: Deploy Core Apps

on: push

# on:
#     push:
#         branches:
#             - main
#             - dev
#             - staging
#             - feature/*
#             - fix/*
#             - hotfix/*
#             - release/*
#         paths:
#             - "core/**"
#     pull_request:
#         branches:
#             - main
#         paths:
#             - "core/**"
#     workflow_dispatch:

env:
    CLOUD_ACCOUNT_NAME: "HELIOS"
    OKE_CLUSTER_NAME: "applications"
    TARGET_SSH_PORT: "6443"

jobs:
    find-cluster:
        secrets:
            DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        uses: mervinhemaraju/workflows/.github/workflows/job-oci-container-get-oke.yaml@feature/setup
        with:
            cloud_account_name: ${{ env.CLOUD_ACCOUNT_NAME }}
            oke_cluster_name: ${{ env.oke_cluster_name }}

    setup-bastion:
        needs: find-cluster
        secrets:
            DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}

        uses: mervinhemaraju/workflows/.github/workflows/job-oci-bastions-pf-session-finder.yaml@feature/setup
        with:
            cloud_account_name: ${{ env.CLOUD_ACCOUNT_NAME }}
            target_ssh_ip_address: ${{ needs.find-cluster.outputs.cluster_private_ip }}
            target_ssh_port: ${{ env.TARGET_SSH_PORT }}

    deploy-apps:
        needs: setup-bastion
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: "Authenticate to Doppler OCI Repo"
              uses: dopplerhq/secrets-fetch-action@v1.3.0
              id: doppler_oci
              with:
                  doppler-token: ${{ secrets.DOPPLER_TOKEN }}
                  doppler-project: cloud-oci-creds
                  doppler-config: prd

            # print bastion ssh command from setup-bastion job outputs
            - name: Print Bastion SSH Command
              run: |
                  echo "${{ needs.setup-bastion.outputs.ssh_command }}"

            # This composite action sets up OCI CLI and creates outputs
            - name: Setup OCI Tools
              id: setup_oci
              uses: mervinhemaraju/workflows/.github/actions/oci-setup@feature/setup
              with:
                  cloud_account_name: ${{ env.CLOUD_ACCOUNT_NAME }}

            - name: Install kubectl
              uses: azure/setup-kubectl@v3
              with:
                  version: "v1.28.0"

            - name: Generate OKE Kubeconfig
              run: |
                  echo "Generating kubeconfig for cluster..."
                  mkdir -p $HOME/.kube

                  oci ce cluster create-kubeconfig \
                      --cluster-id ${{ needs.find-cluster.outputs.cluster_id }} \
                      --file $HOME/.kube/config \
                      --region ${{ steps.setup_oci.outputs.region }} \
                      --token-version 2.0.0

                  echo "✓ Kubeconfig generated successfully"

                  echo "Updating server URL to localhost..."
                  yq eval '.clusters[0].cluster.server = "https://127.0.0.1:6443"' -i $HOME/.kube/config

                  echo "Setting up kubeconfig permissions..."
                  oci setup repair-file-permissions --file /home/runner/.oci/config

            - name: "Setup SSH Keys"
              run: |
                  mkdir -p ~/.oci
                  COMPUTE_PRIVATE_KEY_PATH=~/.oci/oci_compute_private_key.pem

                  echo "${{ steps.doppler_oci.outputs.OCI_COMPUTE_KEY_PRIVATE }}" > $COMPUTE_PRIVATE_KEY_PATH

                  chmod 600 ~/.oci/oci_compute_private_key.pem

            - name: Start Port Forward Tunnel
              run: |
                  echo "Starting SSH port forwarding tunnel..."

                  ${{ needs.setup-bastion.outputs.ssh_command }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -N -f

                  sleep 5

                  if nc -z 127.0.0.1 6443; then
                    echo "✓ Port forwarding tunnel established"
                  else
                    echo "✗ Tunnel failed"
                    exit 1
                  fi

            - name: Test Cluster Connectivity
              run: |
                  echo "Testing cluster connectivity..."
                  echo "Using kubeconfig: $KUBECONFIG"
                  kubectl cluster-info
