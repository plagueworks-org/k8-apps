name: Deploy Core Apps to Zeus Prod Cluster

on:
  push:
    branches:
      - main
      - dev
      - staging
      - feature/*
      - fix/*
      - hotfix/*
      - release/*
    paths:
      - "core/*/base/**"
      - "core/*/overlays/prod/**"
      - "core/global/prod/**"
  pull_request:
    branches:
      - main
    paths:
      - "core/*/base/**"
      - "core/*/overlays/prod/**"
      - "core/global/prod/**"
  workflow_dispatch:

jobs:
  find-cluster:
    secrets:
      DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
    uses: mervinhemaraju/workflows/.github/workflows/job-oci-container-get-oke.yaml@main
    with:
      cloud_account_name: "ZEUS"
      oke_cluster_name: "applications"

  setup-bastion:
    needs: find-cluster
    secrets:
      DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}

    uses: mervinhemaraju/workflows/.github/workflows/job-oci-bastions-pf-session-finder.yaml@main
    with:
      cloud_account_name: "ZEUS"
      target_ssh_ip_address: ${{ needs.find-cluster.outputs.cluster_private_ip }}
      target_ssh_port: "6443"

  deploy-apps:
    needs: [find-cluster, setup-bastion]
    environment: production
    runs-on: ubuntu-latest

    env:
      DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: "Authenticate to Doppler OCI Repo"
        uses: dopplerhq/secrets-fetch-action@v1.3.0
        id: doppler_oci
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN }}
          doppler-project: cloud-oci-creds
          doppler-config: prd

      # print bastion ssh command from setup-bastion job outputs
      - name: Print Bastion SSH Command
        run: |
          echo "${{ needs.setup-bastion.outputs.ssh_command }}"

      # This composite action sets up OCI CLI and creates outputs
      - name: Setup OCI Tools
        id: setup_oci
        uses: mervinhemaraju/workflows/.github/actions/oci-setup@main
        with:
          cloud_account_name: "ZEUS"
          cluster_id: ${{ needs.find-cluster.outputs.cluster_id }}
          install_kubectl: "true"
          generate_kubeconfig: "true"
          setup_ssh_keys: "true"

      - name: Start Port Forward Tunnel
        run: |
          echo "Starting SSH port forwarding tunnel..."

          ${{ needs.setup-bastion.outputs.ssh_command }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -N -f

          sleep 5

          if nc -z 127.0.0.1 6443; then
            echo "✓ Port forwarding tunnel established"
          else
            echo "✗ Tunnel failed"
            exit 1
          fi

      - name: Test Cluster Connectivity
        run: |
          echo "Testing cluster connectivity..."
          echo "Using kubeconfig: $KUBECONFIG"
          kubectl cluster-info

      - name: Create Initial DopplerToken Generic Secret
        run: |

          echo "Creating initial Doppler Token Secret in Default Namespace"

          kubectl create secret generic doppler-token-auth-api \
            --from-literal=dopplerToken='${{ env.DOPPLER_TOKEN }}' \
            --namespace=default \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Core Apps
        uses: plagueworks-org/k8-apps/.github/actions/deploy-core-apps@feature/core-apps-setup
        with:
          environment: "prod"
