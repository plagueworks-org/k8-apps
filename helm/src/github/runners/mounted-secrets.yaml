# External Secret for OCI Configuration
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: runner-oci-config
  namespace: github-runners
spec:
  secretStoreRef:
    name: doppler-cloud-oci-creds
    kind: ClusterSecretStore

  target:
    name: runner-oci-config
    creationPolicy: Owner

    template:
      engineVersion: v2
      data:
        config: |
          [OCI-HELIOS]
          user={{ .oci_helios_user_ocid }}
          fingerprint={{ .oci_fingerprint }}
          tenancy={{ .oci_helios_tenancy_ocid }}
          region=af-johannesburg-1
          key_file=/home/runner/.oci/keys/oci_api_private_key.pem

          [OCI-ZEUS]
          user={{ .oci_zeus_user_ocid }}
          fingerprint={{ .oci_fingerprint }}
          tenancy={{ .oci_zeus_tenancy_ocid }}
          region=af-johannesburg-1
          key_file=/home/runner/.oci/keys/oci_api_private_key.pem

          [OCI-POSEIDON]
          user={{ .oci_poseidon_user_ocid }}
          fingerprint={{ .oci_fingerprint }}
          tenancy={{ .oci_poseidon_tenancy_ocid }}
          region=uk-south-1
          key_file=/home/runner/.oci/keys/oci_api_private_key.pem

          [OCI-GAIA]
          user={{ .oci_gaia_user_ocid }}
          fingerprint={{ .oci_fingerprint }}
          tenancy={{ .oci_gaia_tenancy_ocid }}
          region=uk-south-1
          key_file=/home/runner/.oci/keys/oci_api_private_key.pem
  data:
    - secretKey: oci_helios_user_ocid
      remoteRef:
        key: OCI_HELIOS_USER_OCID

    - secretKey: oci_helios_tenancy_ocid
      remoteRef:
        key: OCI_HELIOS_TENANCY_OCID

    - secretKey: oci_zeus_user_ocid
      remoteRef:
        key: OCI_ZEUS_USER_OCID

    - secretKey: oci_zeus_tenancy_ocid
      remoteRef:
        key: OCI_ZEUS_TENANCY_OCID

    - secretKey: oci_poseidon_user_ocid
      remoteRef:
        key: OCI_POSEIDON_USER_OCID

    - secretKey: oci_poseidon_tenancy_ocid
      remoteRef:
        key: OCI_POSEIDON_TENANCY_OCID

    - secretKey: oci_gaia_user_ocid
      remoteRef:
        key: OCI_GAIA_USER_OCID

    - secretKey: oci_gaia_tenancy_ocid
      remoteRef:
        key: OCI_GAIA_TENANCY_OCID

    - secretKey: oci_fingerprint
      remoteRef:
        key: OCI_API_FINGERPRINT

---
# External Secret for OCI Keys
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: runner-oci-keys
  namespace: github-runners
spec:
  secretStoreRef:
    name: doppler-cloud-oci-creds
    kind: ClusterSecretStore
  target:
    name: runner-oci-keys
    creationPolicy: Owner
  data:
    - secretKey: oci_api_private_key.pem
      remoteRef:
        key: OCI_API_KEY_PRIVATE

    - secretKey: oci_api_public_key.pem
      remoteRef:
        key: OCI_API_KEY_PUBLIC

    - secretKey: oci_compute_private_key.pem
      remoteRef:
        key: OCI_COMPUTE_KEY_PRIVATE

    - secretKey: oci_compute_public_key.pem
      remoteRef:
        key: OCI_COMPUTE_KEY_PUBLIC

---
# External Secret for Cloudflare
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: runner-cloudflare-config
  namespace: github-runners
spec:
  secretStoreRef:
    name: doppler-apps-creds
    kind: ClusterSecretStore
  target:
    name: runner-cloudflare-config
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        ini: |
          dns_cloudflare_api_token = {{ .cloudflare_api_token }}
  data:
    - secretKey: cloudflare_api_token
      remoteRef:
        key: CLOUDFLARE_TERRAFORM_TOKEN